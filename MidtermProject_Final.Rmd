---
title: "MA678 Midterm Project"
author: "Yujia Wang"
date: "December 10, 2021"
output:
  pdf_document: 
          latex_engine: xelatex
  html_document: default
---

```{r setup, include=FALSE}
# set up the environment
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, highlight=FALSE)
knitr::opts_chunk$set(fig.width=6, fig.height=5,fig.align = "center") 
```

```{r}
# source my code
source("MidtermProject_Draft.R")
```


## Abstract

xxx 

## Introduction

xxx
https://www.kaggle.com/debajyotipodder/co2-emission-by-vehicles?select=CO2+Emissions_Canada.csv
https://open.canada.ca/data/en/dataset/98f1a129-f628-4ce4-b24d-6f16bf24dd64/resource/026e45b4-eb63-451f-b34f-d9308ea3a3d9?inner_span=True

## Method

### Data Cleaning and Combining

xxx

|column names                     |explanation|
|:--:                             |:-----|
|Make                             |Company of the vehicle|
|Model                            |Car Model|
|VehicleClass                     |Class of vehicle depending on their utility, capacity and weight|
|EngineSize                       |Size of engine used in Litre|
|Cylinders                        |Number of cylinders|
|Transmission                     |Transmission type with number of gears|
|FuelType                         |Type of Fuel used|
|FC_City                          |Fuel consumption in city roads (L/100 km)|
|FC_Hwy                           |Fuel consumption in highways (L/100 km)|
|FC_Comb                          |The combined fuel consumption (55% city, 45% highway) is shown in L/100 km|
|CO2Emissions                     |The tailpipe emissions of carbon dioxide (in grams per kilometre) for combined city and highway driving|

xxx

### Exploratory Data Analysis

xxx 

```{r, fig.height=7, fig.width=14, fig.cap="xxx"}
# variable "Make" barplot
make_barplot
```

xxx 

```{r, fig.height=7, fig.width=14, fig.cap="xxx"}
# "co2" boxplot
co2_boxplot
```

xxx

```{r, fig.height=7, fig.width=14, fig.cap="xxx"}
# distribution of CO2 emissions histogram
co2_histogram
```

xxx

```{r, fig.height=7, fig.width=14, fig.cap="xxx"}
# ggpairs
ggpairs
```

xxx

```{r, fig.height=7, fig.width=14, fig.cap="xxx"}
# pie plot: VehicleClass, EngineSize, Cylinders, Transmission, FuelType 
pieplot1
pieplot2
pieplot3
pieplot4
pieplot5
```

### Model Fitting

```{r}
ggplot(data=co2_final,aes(y=CO2Emissions,x=FC_Comb,FuelType=factor(FuelType)))+
  geom_point(aes(y=CO2Emissions,x=FC_Comb,color=FuelType),alpha=0.2)+
  geom_smooth(aes(y=CO2Emissions,x=FC_Comb,color=FuelType),se=F,method="lm")+
  xlab("Fuel consumption combination")+
  ylab("CO2 emissions")+
  theme(legend.position="right")

ggplot(data=co2_final,aes(y=CO2Emissions,x=FC_Comb,Cylinders=factor(Cylinders)))+
  geom_point(aes(y=CO2Emissions,x=FC_Comb,color=Cylinders),alpha=0.2)+
  geom_smooth(aes(y=CO2Emissions,x=FC_Comb,color=Cylinders),se=F,method="lm")+
  xlab("Fuel consumption combination")+
  ylab("CO2 emissions")+
  theme(legend.position="right")

ggplot(data=co2_final,aes(y=CO2Emissions,x=FC_Comb,Transmission=factor(Transmission)))+
  geom_point(aes(y=CO2Emissions,x=FC_Comb,color=Transmission),alpha=0.2)+
  geom_smooth(aes(y=CO2Emissions,x=FC_Comb,color=Transmission),se=F,method="lm")+
  xlab("Fuel consumption combination")+
  ylab("CO2 emissions")+
  theme(legend.position="right")

ggplot(data=co2_final,aes(y=CO2Emissions,x=FC_Comb,VehicleClass=factor(VehicleClass)))+
  geom_point(aes(y=CO2Emissions,x=FC_Comb,color=VehicleClass),alpha=0.2)+
  geom_smooth(aes(y=CO2Emissions,x=FC_Comb,color=VehicleClass),se=F,method="lm")+
  xlab("Fuel consumption combination")+
  ylab("CO2 emissions")+
  theme(legend.position="right")
```


```{r, echo=FALSE}
co2_final <- transform(co2_final,Make=as.factor(Make),
                                 Model=as.factor(Model),
                                 VehicleClass=as.factor(VehicleClass),
                                 EngineSize=as.factor(EngineSize),
                                 Cylinders=as.factor(Cylinders),
                                 Transmission=as.factor(Transmission),
                                 FuelType=as.factor(FuelType))
# just a test
model_test <- lmer(CO2Emissions~Transmission+EngineSize+FuelType+FC_Comb+(1|Make),data=co2_final)
summary(model_test)

# formal test
model1 <- lmer(CO2Emissions~FC_Comb+(1+FC_Comb|FuelType)++(1+FC_Comb|),data=co2_final)
summary(model1)




```

```{r}
library(devtools)
devtools::install_github("strengejacke/sjPlot")
library(lme4)
install.packages("sjPlot")
install.packages("sjmisc")
library(sjPlot)
library(sjmisc)
devtools::install_github("strengejacke/strengejacke")

#http://www.strengejacke.de/sjPlot/news/index.html
plot_model(model_test, y.offset = .4)
sjp.lmer(model_test, type = "rs.ri", vars = "c12hour", sample.n = 15)
```


```{r, echo=FALSE}
# zero
model0 <- lmer(CO2Emissions~(1|FuelType ),data=co2_final)
summary(model0)

#
model1 <- lmer(CO2Emissions~Cylinders+(1|FuelType ),data=co2_final)
summary(model1)

#
AIC(model0)
BIC(model0)
deviance(model0,REML=FALSE)
AIC(model1)
BIC(model1)
deviance(model1,REML=FALSE)


library("lmerTest")
#install.packages("bruceR")
library("bruceR")
HLM_summary(fit)

#install.packages("MuMIn")
library("MuMIn")


fit <- lmer(CO2Emissions~FC_City+FC_Hwy+FC_Comb+(1+FC_Comb|FuelType),data=co2_final)
#+(1+log_duration|categories)+(1+log_views|categories)+(1+log_numlang|categories)
coef(fit)
summary(fit)

anova( , , )
install.packages("texreg")
library("texreg")
texreg::screenreg(list( , , ))
```
|Make                       
|Model                       
|VehicleClass                
|EngineSize                      
|Cylinders                    
|Transmission            
|FuelType                       
|FC_City                      
|FC_Hwy                       
|FC_Comb         
|CO2Emissions 

xxx

```{r}
# complete pooling
ggplot(co2_final)+geom_point()+aes(x=Cylinders,y=CO2Emissions)+geom_smooth(method="lm",se=FALSE)

# no pooling
ggplot(co2_final)+geom_point()+aes(x=FuelType,y=CO2Emissions,color=factor(Make))+geom_smooth(method="lm",se=FALSE)+facet_wrap(~Make)

```

## Result

## Model Coefficients

xxx

$$log(comments)= -12.70 + 0.77\cdot log(duration) + 0.32\cdot log(views) + 2.15\cdot log(numlang)$$

xxx

### Model Validation

```{r echo=FALSE, fig.height=2.5, fig.width=6, fig.cap="Residual plot and Q-Q plot."}
#binnedplot(fitted(fit4),resid(fit4))
re <- plot(fit)
qq <- qqmath(fit)
grid.arrange(re,qq,nrow=1)
```

```{r echo=FALSE, fig.height=2, fig.width=4, fig.cap="Residuals vs Leverage."}
ggplot(data.frame(lev=hatvalues(fit4),pearson=residuals(fit4,type="pearson")),
      aes(x=lev,y=pearson)) +
    geom_point() +
    theme_bw()
```
   
xxx

## Discussion

xxx

## Citation

xxx    

\newpage
## Appendix
```{r, echo=FALSE}
# scatter plot matrices
#install.packages("psych")
library("psych")
pairs.panels(co2_final)
```






